---
title: Использование SAML для единого входа из Power BI в локальные источники данных
description: Настройте на шлюзе SAML, чтобы включить единый вход из Power BI в локальные источники данных.
author: arthiriyer
ms.author: arthii
ms.reviewer: ''
ms.service: powerbi
ms.subservice: powerbi-gateways
ms.topic: how-to
ms.date: 12/16/2020
LocalizationGroup: Gateways
ms.openlocfilehash: 21371e931aa123aa6a339bfbcb939bde943b3f9f
ms.sourcegitcommit: 5c09d121d3205e65fb33a2eca0e60bc30e777773
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/18/2020
ms.locfileid: "97675518"
---
# <a name="use-security-assertion-markup-language-saml-for-sso-from-power-bi-to-on-premises-data-sources"></a>Использование SAML для единого входа из Power BI в локальные источники данных

Включение единого входа позволяет отчетам и панелям мониторинга Power BI легко обновлять данные из локальных источников с учетом разрешений, настроенных для таких источников на уровне пользователей. Используйте [язык разметки заявлений системы безопасности (SAML)](https://www.onelogin.com/pages/saml), чтобы включить простой единый вход. 

## <a name="supported-data-sources"></a>Поддерживаемые источники данных

Сейчас мы поддерживаем SAP HANA с SAML. Дополнительные сведения об установке и настройке единого входа для SAP HANA с помощью SAML см. в разделе [Единый вход через SAML для платформы бизнес-аналитики в HANA](https://blogs.sap.com/2020/03/22/sap-bi-platform-saml-sso-to-hana-database/).

Мы поддерживаем набор дополнительных источников данных (включая SAP HANA) с помощью [Kerberos](service-gateway-sso-kerberos.md).

Для SAP HANA рекомендуется включить шифрование, прежде чем устанавливать подключение единого входа SAML. Чтобы включить шифрование, настройте на сервере HANA прием зашифрованных подключений и настройте на шлюзе шифрование для взаимодействия с сервером HANA. Так как драйвер ODBC для HANA не шифрует утверждения SAML по умолчанию, то, если не включить шифрование, подписанные утверждения SAML будут отправляться со шлюза на сервер HANA *в открытом виде* и могут быть перехвачены и повторно использованы третьими лицами.

> [!IMPORTANT]
> Так как [SAP больше не поддерживает OpenSSL](https://help.sap.com/viewer/b3ee5778bc2e4a089d3299b82ec762a7/2.0.05/en-US/de15ffb1bb5710148386ffdfd857482a.html), корпорация Майкрософт также прекратила поддержку этой библиотеки. Существующие подключения продолжат работать, но вы не сможете создавать новые подключения начиная с февраля 2021 г. В дальнейшем используйте библиотеку CommonCryptoLib.

## <a name="configuring-the-gateway-and-data-source"></a>Настройка шлюза и источника данных

Чтобы использовать SAML, необходимо установить отношение доверия между серверами HANA, для которых вы хотите включить единый вход, и шлюзом. В этом сценарии шлюз выступает в качестве поставщика удостоверений SAML (IdP). Существует несколько способов установить эти отношения. SAP рекомендует библиотеку шифрования SAP (также известную как CommonCryptoLib или sapcrypto), чтобы завершить установку отношения доверия во время настройки. Дополнительные сведения см. в официальной документации SAP.

Ниже описано, как установить отношение доверия между сервером HANA и поставщиком удостоверений шлюза путем подписывания сертификата X509 поставщика удостоверений шлюза с помощью сертификата корневого центра сертификации (ЦС), который является доверенным для сервера HANA. 

### <a name="create-the-certificates"></a>Создание сертификатов

Чтобы создать сертификаты, выполните указанные ниже действия.

1. На устройстве, на котором выполняется SAP HANA, создайте пустую папку для хранения сертификатов, а затем перейдите к этой папке.
2. Создайте корневые сертификаты, выполнив следующую команду:

   ```
   openssl req -new -x509 -newkey rsa:2048 -days 3650 -sha256 -keyout CA_Key.pem -out CA_Cert.pem -extensions v3_ca'''
   ```

    Необходимо запомнить парольную фразу, чтобы использовать этот сертификат для подписи других сертификатов.
    Будут созданы файлы *CA_Cert.pem* и *CA_Key.pem*.

   
3. Создайте сертификаты IdP, выполнив следующую команду:
 
    ```
    openssl req -newkey rsa:2048 -days 365 -sha256 -keyout IdP_Key.pem -out IdP_Req.pem -nodes
    ```
    Будут созданы файлы *IdP_Key.pem* и *IdP_Req.pem*.

4. Подпишите сертификаты IdP с помощью корневых сертификатов:

    ```
    openssl x509 -req -days 365 -in IdP_Req.pem -sha256 -extensions usr_cert -CA CA_Cert.pem -CAkey CA_Key.pem -CAcreateserial -out IdP_Cert.pem
    ```
    Будут созданы файлы *CA_Cert.srl* и *IdP_Cert.pem*.
    Нас интересует только *IdP_Cert.pem*.    

### <a name="create-saml-identity-provider-certificate-mapping"></a>Создание сопоставления сертификатов поставщика удостоверений SAML

Создайте сопоставление сертификатов поставщика удостоверений SAML, выполнив следующие действия.

1. В **SAP HANA Studio** щелкните правой кнопкой мыши имя сервера SAP HANA, а затем перейдите к разделу **Безопасность > Открыть консоль безопасности > Поставщик удостоверений SAML**.
2. Если криптографическая библиотека SAP не выбрана, выберите ее. *Не* используйте криптографическую библиотеку OpenSSL (слева на следующем изображении), она является нерекомендуемой в SAP.

    ![Выбор криптографической библиотеки SAP](media/service-gateway-sso-saml/service-gateway-sso-saml-01.png)

3. Импортируйте подписанный сертификат *IdP_Cert.pem*, нажав синюю кнопку импорта, как показано на следующем рисунке.

    ![Нажатие синей кнопки импорта](media/service-gateway-sso-saml/service-gateway-sso-saml-02.png)

Не забудьте присвоить имя *поставщику удостоверений*.

### <a name="import-and-create-the-signed-certificates-in-hana"></a>Импорт и создание подписанных сертификатов в HANA

Затем вы импортируете и создадите подписанные сертификаты в HANA. Выполните следующие действия.

1. В **HANA Studio** выполните следующий запрос:

    ```
    CREATE CERTIFICATE FROM '<idp_cert_pem_certificate_content>'
    ```
    
    Пример:

    ```
    CREATE CERTIFICATE FROM
    '-----BEGIN CERTIFICATE-----
    MIIDyDCCArCgA...veryLongString...0WkC5deeawTyMje6
    -----END CERTIFICATE-----
    '
    ```

2. Если цель SAML PSEwith отсутствует, создайте ее, выполнив следующий запрос в **HANA Studio**:
    
    ```
    CREATE PSE SAMLCOLLECTION;<br>set pse SAMLCOLLECTION purpose SAML;<br>
    ```

3. Добавьте созданный подписанный сертификат в PSE с помощью следующей команды:

    ```
    alter pse SAMLCOLLECTION add CERTIFICATE <certificate_id>;
    ```

    Пример:
    ```
    alter pse SAMLCOLLECTION add CERTIFICATE 1978320;
    ```

    Список созданных сертификатов можно проверить с помощью следующего запроса:
    ```
    select * from PUBLIC"."CERTIFICATES"
    ```

    Теперь сертификат установлен правильно. Для подтверждения можно выполнить следующий запрос:
    ```
    select * from "PUBLIC"."PSE_CERTIFICATES"
    ```

### <a name="map-the-user"></a>Сопоставление пользователя

Выполните следующие действия, чтобы сопоставить пользователя:

1. В **SAP HANA Studio** выберите папку **Безопасность**:

    ![Выбор папки "Безопасность"](media/service-gateway-sso-saml/service-gateway-sso-saml-03.png)

2. Разверните раздел **Пользователи**, а затем выберите нужного пользователя, с которым необходимо сопоставить пользователя Power BI.

3. Установите флажок **SAML**, а затем выберите **Настройка**, как показано на следующем изображении.

    ![Выбор SAML, затем ссылки "Настроить"](media/service-gateway-sso-saml/service-gateway-sso-saml-04.png)

4. Выберите поставщика удостоверений, созданного в разделе [Создание сопоставления сертификатов поставщика удостоверений SAML](#create-saml-identity-provider-certificate-mapping) ранее в этой статье. В поле "Внешнее удостоверение" введите имя субъекта-пользователя Power BI (обычно это адрес электронной почты, с помощью которого пользователь входит в Power BI), а затем выберите команду **Добавить**.  На приведенном ниже изображении показано, как выбрать эти элементы.

    ![Окно "Настройка удостоверений SAML"](media/service-gateway-sso-saml/service-gateway-sso-saml-05.png)

    Если вы настроили шлюз для использования параметра конфигурации *ADUserNameReplacementProperty*, нужно ввести значение, которое заменит изначальное имя субъекта-пользователя Power BI. Например, если задать для *ADUserNameReplacementProperty* значение *SAMAccountName*, вам нужно ввести *SAMAccountName* пользователя.

### <a name="configure-the-gateway"></a>Настройка шлюза

Теперь, когда у вас есть настроенные удостоверение и сертификат шлюза, преобразуйте сертификат в формат PFX и настройте его использование на шлюзе, выполнив следующие действия.

1. Преобразуйте сертификат в формат PFX, выполнив указанную ниже команду. Эта команда присваивает полученному PFX-файлу имя samlcert.pfx и устанавливает *root* в качестве пароля к нему.

    ```
    openssl pkcs12 -export -out samltest.pfx -in IdP_Cert.pem -inkey IdP_Key.pem -passin pass:root -passout pass:root
    ```

2. Скопируйте PFX-файл на компьютер шлюза:

    1. Дважды щелкните файл *samltest.pfx*, а затем выберите пункты **Локальный компьютер** > **Далее**.

    2. Введите пароль, а затем нажмите кнопку **Далее**.

    3. Установите переключатель в положение **Разместить все сертификаты в следующем хранилище** и выберите **Обзор**  > **Личные**  > **ОК**.

    4. Выберите пункт **Далее**, затем — **Готово**.

       ![Импорт сертификата](media/service-gateway-sso-saml/service-gateway-sso-saml-06.png)

3. Предоставьте учетной записи службы шлюза доступ к закрытому ключу сертификата, выполнив следующие действия:

    1. На компьютере шлюза запустите консоль управления (MMC).

        ![Запуск MMC](media/service-gateway-sso-saml/run-mmc.png)

    2. В меню **Файл** выберите команду **Добавить или удалить оснастку**.

        ![Добавление оснастки](media/service-gateway-sso-saml/add-snap-in.png)

    3. Выберите пункты **Сертификаты** > **Добавить**, а затем — **Учетная запись компьютера** > **Далее**.

    4. Выберите **Локальный компьютер** > **Готово** > **ОК**.

    5. Разверните узел **Сертификаты** > **Личные** > **Сертификаты** и найдите сертификат.

    6. Щелкните сертификат правой кнопкой мыши и перейдите к разделу **Все задачи** &gt; **Управление закрытыми ключами**.

        ![Управление закрытыми ключами](media/service-gateway-sso-saml/manage-private-keys.png)

    1. Добавьте учетную запись службы шлюза в список. По умолчанию учетная запись — это **NT SERVICE\PBIEgwService**. Можно выяснить, какую учетную запись служба шлюза использует для работы, запустив **services.msc** и найдя **локальную службу шлюза данных**.

        ![Служба шлюза](media/service-gateway-sso-saml/gateway-service.png)

Наконец, выполните следующие действия для добавления отпечатка сертификата в конфигурацию шлюза.

1. Выполните следующую команду PowerShell, чтобы получить список сертификатов на вашем компьютере.

    ```powershell
    Get-ChildItem -path cert:\LocalMachine\My
    ```

2. Скопируйте отпечаток сертификата, который вы создали.

3. Перейдите в каталог шлюза. По умолчанию используется *C:\Program Files\On-premises data gateway*.

4. Откройте файл *PowerBI.DataMovement.Pipeline.GatewayCore.dll.config* и найдите раздел *SapHanaSAMLCertThumbprint*. Вставьте скопированный отпечаток.

5. Перезапустите службу шлюза.

## <a name="running-a-power-bi-report"></a>Запуск отчета Power BI

Теперь вы можете использовать страницу **Управление шлюзом** в Power BI, чтобы настроить источник данных SAP HANA. В разделе **Дополнительные параметры** включите единый вход с помощью SAML. Это позволяет публиковать отчеты и наборы данных с привязкой к этому источнику данных.

   ![Дополнительные настройки](media/service-gateway-sso-saml/advanced-settings.png)

## <a name="troubleshooting"></a>Диагностика

После настройки единого входа на основе SAML вы можете увидеть на портале Power BI следующую ошибку: *Указанные учетные данные невозможно использовать для источника SapHana*. Эта ошибка означает, что учетные данные SAML были отклонены SAP HANA.

Для устранения неполадок с учетными данными в SAP HANA вы можете получить подробные сведения, используя трассировки проверки подлинности на стороне сервера. Чтобы настроить трассировку для сервера SAP HANA, выполните следующие действия.

1. На сервере SAP HANA включите трассировку проверки подлинности, запустив следующий запрос.

    ```
    ALTER SYSTEM ALTER CONFIGURATION ('indexserver.ini', 'SYSTEM') set ('trace', 'authentication') = 'debug' with reconfigure 
    ```

1. Воспроизведите проблему.

1. В HANA Studio откройте консоль администрирования и перейдите на вкладку **Diagnosis Files** (Файлы диагностики).

1. Откройте последнюю трассировку сервера индекса и найдите *SAMLAuthenticator.cpp*.

    В файле должно быть подробное сообщение об ошибке с указанием основной причины, как в следующем примере.

    ```
    [3957]{-1}[-1/-1] 2018-09-11 21:40:23.815797 d Authentication   SAMLAuthenticator.cpp(00091) : Element '{urn:oasis:names:tc:SAML:2.0:assertion}Assertion', attribute 'ID': '123123123123123' is not a valid value of the atomic type 'xs:ID'.
    [3957]{-1}[-1/-1] 2018-09-11 21:40:23.815914 i Authentication   SAMLAuthenticator.cpp(00403) : No valid SAML Assertion or SAML Protocol detected
    ```

1. После завершения устранения неполадок отключите трассировку проверки подлинности, выполнив следующий запрос.

    ```
    ALTER SYSTEM ALTER CONFIGURATION ('indexserver.ini', 'SYSTEM') UNSET ('trace', 'authentication');
    ```

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о локальном шлюзе данных и DirectQuery см. в следующих ресурсах:

* [Что такое локальный шлюз данных?](/data-integration/gateway/service-gateway-onprem)
* [Power BI и DirectQuery](desktop-directquery-about.md)
* [Источники данных, поддерживаемые DirectQuery](power-bi-data-sources.md)
* [Использование DirectQuery и SAP Business Warehouse (BW)](desktop-directquery-sap-bw.md)
* [DirectQuery и SAP HANA](desktop-directquery-sap-hana.md)
